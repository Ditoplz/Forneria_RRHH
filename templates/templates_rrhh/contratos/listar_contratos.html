{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
{% endblock %}

{% block navbar %}
    {% include 'includes/navbar.html' %}
{% endblock %}

{% block contenido %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark">Listado de Contratos</h2>

        <div>
            <a href="{% url 'mantenedor_empleados' %}" class="btn btn-outline-dark me-2"><i class="bi bi-arrow-left-circle-fill me-1"></i>Volver</a>
            <a href="{% url 'crear_contrato' %}" class="btn text-white" style="background-color: #B22222;"><i class="bi bi-plus-circle-fill me-1"></i>Crear Contrato</a>
        </div>
    </div>

    <!-- Barra de Búsqueda -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" action="{% url 'listar_contratos' %}" id="searchForm">
                <label for="q" class="form-label fw-bold">Buscar por Empleado</label>
                <input type="text" name="q" id="q" class="form-control" value="{{ query|default:'' }}" placeholder="Escribe un nombre para buscar...">
            </form>
        </div>
    </div>

    <div class="card border-0 shadow-lg rounded-4">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="text-white" style="background: linear-gradient(90deg, #8B0000, #B22222);">
                    <tr>
                        <th>ID</th>
                        <th>Empleado</th>
                        <th>Tipo Contrato</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Fin</th>
                        <th>Renta Bruta</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
        <tbody id="contratos-table-body">
        {% for c in contratos %}
            <tr>
                <td>{{ c.id }}</td>
                <td>{{ c.empleado.nombres }} {{ c.empleado.a_paterno }}</td>
                <td>{{ c.tipo_contrato.nombre }}</td>
                <td>{{ c.fecha_inicio|date:"d-m-Y" }}</td>
                <td>{{ c.fecha_fin|date:"d-m-Y"|default:"Indefinido" }}</td>
                <td>${{ c.renta_bruta }}</td>
                <td>
                    <a href="{% url 'editar_contrato' c.id %}" class="btn btn-sm btn-info" title="Editar"><i class="bi bi-pencil-square"></i></a>
                    <a href="{% url 'eliminar_contrato' c.id %}" class="btn btn-danger btn-sm" title="Eliminar">
                       <i class="bi bi-trash3"></i>
                    </a>
                    <a href="#" class="btn btn-sm text-white export-btn-individual" style="background-color: #fd7e14;" data-contrato-id="{{ c.id }}" title="Exportar">
                       <i class="bi bi-file-earmark-arrow-down-fill"></i>
                    </a>
                </td>
            </tr>
        {% empty %}
            <tr><td colspan="7" class="text-center">No hay contratos registrados.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

{% block javascripts %}
<!-- SweetAlert2 para diálogos modales atractivos -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- jsPDF para la generación de PDFs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<!-- Tu script personalizado -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('q');
    const tableBody = document.getElementById('contratos-table-body');

    const fetchContratos = () => {
        const query = searchInput.value;
        const url = `{% url 'listar_contratos' %}?q=${encodeURIComponent(query)}`;

        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            tableBody.innerHTML = '';

            if (data.contratos && data.contratos.length > 0) {
                data.contratos.forEach(c => {
                    const editarUrl = `/rrhh/contratos/editar/${c.id}/`;
                    const eliminarUrl = `/rrhh/contratos/eliminar/${c.id}/`;

                    // Formatear fechas
                    const fechaInicio = new Date(c.fecha_inicio).toLocaleDateString('es-CL');
                    const fechaFin = c.fecha_fin ? new Date(c.fecha_fin).toLocaleDateString('es-CL') : 'Indefinido';

                    const row = `
                        <tr>
                            <td>${c.id}</td>
                            <td>${c.empleado__nombres} ${c.empleado__a_paterno}</td>
                            <td>${c.tipo_contrato__nombre}</td>
                            <td>${fechaInicio}</td>
                            <td>${fechaFin}</td>
                            <td>$${c.renta_bruta}</td>
                            <td>
                                <a href="${editarUrl}" class="btn btn-sm btn-info" title="Editar">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <a href="${eliminarUrl}" class="btn btn-danger btn-sm" title="Eliminar"><i class="bi bi-trash3"></i></a>
                                <a href="#" class="btn btn-sm text-white export-btn-individual" style="background-color: #fd7e14;" data-contrato-id="${c.id}" title="Exportar">
                                    <i class="bi bi-file-earmark-arrow-down-fill"></i>
                                </a>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No se encontraron contratos que coincidan con la búsqueda.</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error al realizar la búsqueda AJAX:', error);
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Ocurrió un error al buscar.</td></tr>';
        });
    };

    let debounceTimer;

    searchInput.addEventListener('keyup', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(fetchContratos, 300);
    });

    // --- Lógica para Exportar Individualmente ---
    // Usamos delegación de eventos en el 'document' para asegurar que funcione
    // incluso si el 'tbody' es reemplazado completamente.
    document.addEventListener('click', function(e) {
        console.log('Clic detectado en el documento.'); // Punto de control 1

        // Verificamos que el clic ocurrió dentro de nuestra tabla
        const tableBody = document.getElementById('contratos-table-body');
        if (!tableBody || !tableBody.contains(e.target)) {
            // console.log('Clic fuera de la tabla de contratos. Ignorando.'); // Opcional: descomentar para más detalle
            return;
        }
        console.log('Clic dentro de la tabla de contratos.'); // Punto de control 2

        const exportBtn = e.target.closest('.export-btn-individual'); // Botón de exportar
        const deleteLink = e.target.closest('a[href*="eliminar"]'); // Enlace de eliminar
        
        if (deleteLink) {
            e.preventDefault();
            console.log('Botón de eliminar presionado.', deleteLink.href); // Punto de control 3a

            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡No podrás revertir esta acción!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, ¡eliminar!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = deleteLink.href;
                }
            });
        } else if (exportBtn) { // Usamos 'else if' para separar la lógica
            e.preventDefault();
            console.log('Botón de exportar presionado.', exportBtn.dataset.contratoId); // Punto de control 3b
            const contratoId = exportBtn.dataset.contratoId;
            const row = exportBtn.closest('tr');

            Swal.fire({
                title: 'Seleccione el formato de exportación',
                text: `¿Desea exportar el contrato #${contratoId} como Word o PDF?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Word (.doc)',
                cancelButtonText: 'Cancelar',
                showDenyButton: true,
                denyButtonText: `PDF (.pdf)`,
            }).then((result) => {
                if (result.isConfirmed) {
                    exportRowToDoc(row, `contrato_${contratoId}.doc`);
                    Swal.fire('¡Exportado!', 'El archivo Word ha sido generado.', 'success');
                } else if (result.isDenied) {
                    exportRowToPdf(row, `contrato_${contratoId}.pdf`, `Detalle de Contrato #${contratoId}`);
                    Swal.fire('¡Exportado!', 'El archivo PDF ha sido generado.', 'success');
                }
            });
        }
    });

    function exportRowToDoc(row, filename = '') {
        if (!row) {
            console.error('No se encontró la fila para exportar.');
            return;
        }

        let data = "Datos del Contrato:\n\n";
        
        const table = row.closest('table');
        const headers = [];
        table.querySelectorAll("thead th").forEach(header => {
            if (header.textContent.trim() !== 'Acciones') {
                headers.push(header.textContent.trim());
            }
        });

        const rowData = [];
        row.querySelectorAll("td").forEach((cell, index) => {
            if (index < headers.length) { 
                rowData.push(cell.textContent.trim());
            }
        });

        for (let i = 0; i < headers.length; i++) {
            data += `${headers[i]}: ${rowData[i]}\n`;
        }

        const blob = new Blob([data], { type: 'application/octet-stream' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function exportRowToPdf(row, filename = '', title = '') {
        if (!row) {
            console.error('No se encontró la fila para exportar a PDF.');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Encabezados de la tabla
        const table = row.closest('table');
        const headers = [];
        table.querySelectorAll("thead th").forEach(header => {
            if (header.textContent.trim() !== 'Acciones') {
                headers.push(header.textContent.trim());
            }
        });

        // Datos de la fila
        const rowData = [];
        row.querySelectorAll("td").forEach((cell, index) => {
            if (index < headers.length) { 
                rowData.push(cell.textContent.trim());
            }
        });

        // Transformar datos a formato [Campo, Valor] para la tabla del PDF
        const body = headers.map((header, index) => [header, rowData[index]]);

        doc.setFontSize(18);
        doc.text(title, 14, 22);

        doc.autoTable({
            startY: 30,
            head: [['Campo', 'Valor']],
            body: body,
        });

        doc.save(filename);
    }
});
</script>
{% endblock %}