{% extends 'base.html' %}
{% load static %}

{% block navbar %}
    {% include 'includes/navbar.html' %}
{% endblock %}

{% block contenido %}

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark">Listado de Contratos</h2>

        <div>
            <a href="{% url 'mantenedor_contratos' %}" class="btn btn-outline-dark me-2"><i class="bi bi-arrow-left-circle-fill me-1"></i>Volver</a>
            <a href="{% url 'crear_contrato' %}" class="btn text-white" style="background-color: #B22222;"><i class="bi bi-plus-circle-fill me-1"></i>Crear Nuevo Contrato</a>
        </div>
    </div>

    <!-- Formulario de Búsqueda y Filtros -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" action="{% url 'listar_contratos' %}" id="searchForm">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label for="q" class="form-label fw-bold">Buscar por Empleado</label>
                        <input type="text" name="q" id="q" class="form-control" value="{{ query|default:'' }}" placeholder="Ej: Juan Pérez">
                    </div>
                    <div class="col-md-3">
                        <label for="filtro_vigencia" class="form-label fw-bold">Filtro de Vigencia</label>
                        <select name="filtro_vigencia" id="filtro_vigencia" class="form-select">
                            <option value="todos" {% if filtro_vigencia == 'todos' %}selected{% endif %}>Todos</option>
                            <option value="vigentes" {% if filtro_vigencia == 'vigentes' %}selected{% endif %}>Vigentes</option>
                            <option value="vencidos" {% if filtro_vigencia == 'vencidos' %}selected{% endif %}>Vencidos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filtro_visibilidad" class="form-label fw-bold">Ver</label>
                        <select name="filtro_visibilidad" id="filtro_visibilidad" class="form-select">
                            <option value="activos" {% if filtro_visibilidad == 'activos' %}selected{% endif %}>Activos</option>
                            <option value="eliminados" {% if filtro_visibilidad == 'eliminados' %}selected{% endif %}>Eliminados</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card border-0 shadow-lg rounded-4">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="text-white" style="background: linear-gradient(90deg, #8B0000, #B22222);">
                    <tr>
                        <th>Empleado</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Fin</th>
                        <th>Sueldo Base</th>
                        <th>Acciones</th>
                    </tr>
                </thead>

        <tbody id="contract-table-body">
            {% for contrato in contratos %}
            <tr>
                <td>{{ contrato.empleado.nombres }}</td>
                <td>{{ contrato.fecha_inicio }}</td>
                <td>{{ contrato.fecha_fin }}</td>
                <td>{{ contrato.sueldo_base }}</td>
                <td>
                    <a href="{% url 'editar_contrato' contrato.id %}" class="btn btn-sm btn-info"><i class="bi bi-pencil-square"></i></a>
                    <a href="{% url 'eliminar_contrato' contrato.id %}" class="btn btn-danger btn-sm"><i class="bi bi-trash3"></i></a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center">No se encontraron contratos con los filtros aplicados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('searchForm');
    const tableBody = document.getElementById('contract-table-body');
    const searchInput = document.getElementById('q');
    const vigenciaSelect = document.getElementById('filtro_vigencia');
    const visibilidadSelect = document.getElementById('filtro_visibilidad');

    const performSearch = () => {
        const searchTerm = searchInput.value.toLowerCase();
        const vigencia = vigenciaSelect.value;
        const visibilidad = visibilidadSelect.value;
        const rows = tableBody.getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.getElementsByTagName('td');
            if (cells.length > 0) { // Asegurarse de que no es una fila de "no encontrado"
                const rowData = row.textContent || row.innerText;
                
                if (rowData.toLowerCase().includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }
    };

    // Para la barra de búsqueda de texto
    searchInput.addEventListener('keyup', performSearch);

    // Para los filtros <select>, que recargan la página
    vigenciaSelect.addEventListener('change', () => form.submit());
    visibilidadSelect.addEventListener('change', () => form.submit());
    });
</script>
{% endblock %}
